name: D2D Pipeline Template
on:
  workflow_call:
    inputs:
      artifact-name:
        description: "The name of the artifact where build archive is stored"
        required: true
        type: string
      archive-name:
        description: "Build archive file name"
        required: true
        type: string
      steps:
        description: "Comma separated D2D optional steps to run"
        required: false
        type: string
        default: ""

jobs:
  run-d2d-pipeline:
    runs-on: 'ubuntu-latest'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs['artifact-name'] }}
          path: dist/

      - name: Prepare inputs for d2d
        shell: bash
        run: |
          mkdir -p scancode-inputs
          git archive --format=tar.gz -o scancode-inputs/from.tar.gz HEAD
          cp dist/${{ inputs['archive-name'] }} scancode-inputs/to_${{ inputs['archive-name'] }}

      - name: Run d2d pipeline
        uses: aboutcode-org/scancode-action@beta
        with:
          pipelines: ${{ inputs.steps && format('map_deploy_to_develop:%s', inputs.steps) || 'map_deploy_to_develop' }}
